---
title: "Mapeo de la distribución del ingreso en la Ciudad de Buenos Aires"
author: "Felipe González"
date: "17 de julio de 2015"
output: html_document
---
```{r,libraries,message=FALSE,echo=FALSE}
rm(list=ls())
source("src/libraries.R")
source("src/functions.R")
source("src/loadingEAHUdata.R")
source("src/processingEAHU.R")
```


#Introducción

El propósito de este trabajo es mapear la distribución del ingreso en la Ciudad de Buenos Aires. El análisis de la distribución del ingreso en su dimensión espacial arroja otra perspectiva que enriquece el análisis y puede utilizarse más adelante como insumo para otros análisis (como puede ser por ejemplo la relación entre esta distribución y la topografía de las redes de servicios públicos provistos por un municipio, o su recaudación impositiva segregada por barrios).

Para ello, se utilizará el Censo Nacional de Hogares y Población de 2010 (Censo de aquí en más), dado que es la única fuente estadística que ofrece información desagregada a un nivel geográfico lo suficientemente específico como para realizar mapas que sean significativos. Lamentablemente, el Censo no pregunta por ingreso de manera directa, con lo cual el desafío radica en proponer un proceso que permita a partir de las variables existentes en el censo, llegar a un proxy del ingreso del hogar.

La Encuesta Anual de Hogares Urbanos (EAHU) permite validar la relación existente entre determinadas variables a seleccionar y el ingreso del hogar (los diferentes tipos de ingresos). Esta base a su vez, no ofrece niveles de desagregación geográficos útiles, más allá de grandes aglomerados urbanos. Es por ello que el uso complementario de ambas puede llevar a alcanzar el objetivo deseado.

Con este objetivo principal como norte, el trabajo presenta los siguiente objetivos secundarios:

- Analizar las variables disponibles en el Censo 2010 y la EAHU del tercer trimestre del 2010 y comparar las variables que ambas tienen en común y las diferencias que pueda llegar a haber hacia el interior de cada una
- Determinar, entre las variables que comparten el Censo y la EAHU, cual de ellas (ya sea en modo individual o como combinatoria de las mismas en un índice o indicador) presenta la mayor relación con el ingreso
- Obtener del Censo 2010 los valores para esa variable (individual o compuesta) a nivel de radio censal
- Mapear esa variable en mapa de la Ciudad Autónoma de Buenos Aires
- Esbozar un primer análisis del mapa del ingreso de la Ciudad 

#El ingreso en la Ciudad de Buenos Aires

- Medir el GDB 2010 per capita y comparar con las otras provincias
- Comparar gini para todas las areas urbanas por provincia
- Especificar que vamos a hablar de ingreso per capita familiar

#Variables comunes al Censo 2010 y EAHU

La **Tabla Nº 1** resume las variables que tanto **Censo** como **EAHU** miden y que serán utilizadas en este trabajo para intentar realizar una estimación de la distribución espacial del ingreso. 


| **CENSO**                                                    | **EAHU**      |
| -------------------------------------------------------------|---------------|
| **Hogares**                                                  | **Hogares**   |
| V01 - Tipo de vivienda                                       | IV1 - Tipo de vivienda|
| H16 - Total de ambientes                                     | IV2 - Total de ambientes|
| H05 - Material predominante de los pisos                     | IV3 - Material predominante de pisos interiores|
| H06 - Material de la cubierta exterior del techo             | IV4 - Material de la cubierta exterior del techo|
| H07 - Revestimiento interior o cielorraso del techo          | IV5 - Revestimiento interior o cielorraso del techo|
| H08 - Tenencia de agua                                       | IV6 - Tenencia de agua|
| H09 - Procedencia del agua para beber y cocinar              | IV7 – Fuente de agua|
| H10 - Tiene baño o letrina                                   | IV8 - Tiene baño o letrina|
| H11 - Tiene botón, cadena, mochila para limpieza del inodoro | IV10 - Tiene botón, cadena, mochila para limpieza del inodoro|
| H12 - Desagüe del inodoro                                    | IV11 - Desagüe del inodoro |
| H14 - Combustible usado principalmente para cocinar          | II8 - Combustible utilizado para cocinar |
| PROP - Tenencia de la vivienda y propiedad del terreno       | II7 - Régimen de tenencia |
|                                                              |               |
| **Personas**                                                 | **Personas**  |
| P01 - Relación de parentesco                                 | CH03 - Relación de Parentesco      |
| P02 - Sexo                                                   | CH04 - Sexo       |
| P05 - Pais de nacimiento                                     | CH15 - Pais de nacimiento|
| P03 - Edad                                                   | CH06 - Edad       |
| P08 - Asiste o asistió a un establecimiento educativo        | CH10 - Asiste o asistió a un establecimiento educativo     |
| P09 - Nivel educativo que cursa o cursó                      | CH12 - Nivel educativo que cursa o cursó        |
| P10 - Completó ese nivel                                     | CH13 - Completó ese nivel        |
| P11A- Ultimo grado que aprobó en ese nivel                   | CH14 - Último grado que aprobó en ese nivel        |
| CONDACT - Condición de actividad                             | ESTADO - Condición de actividad      |


En la medida en que Buenos Aires presenta el mayor nivel de ingreso per cápita, así como también es un espacio urbano consolidado ya que es una de las ciudades cuyo proceso de urbanización data de los tiempos de la colonia, es de esperar que algunas variables vinculadas a aspectos de la pobreza estructural no tengan tanta incidencia. 

Un ejemplo de ello es la fuente de procedencia del agua donde todos los hogares tienen agua corriente. E incluso son una minoría (el `r round(prop.table(xtabs(pondera ~ iv8 ,hogares))[[2]]*100,2)`%) los que no tienen baño o solo el `r round(prop.table(xtabs(pondera ~ iv6 ,hogares))[[2]]*100,2)`% el que tiene agua por fuera de la vivienda. En este sentido, no es esperable que estas variables sirvan como proxy para una variable con mucha variabilidad como el ingreso en la Ciudad de Buenos Aires.

Por otro lado, las variables que hacen a los materiales de la vivienda o al mecanismo de disposición de desechos en el baño, presentan mayor variabilidad y puede ser que esten relacionadas con el ingreso. Sin embargo, este set de variables es de esperar que solamente sirva para distinguir positivamente sectores de bajos ingresos, más no así para permitir la georeferenciación de los sectores de altos ingresos. Mientras que la ausencia de baño con desagüe o de calidad suficiente en el techo o piso de la vivienda podría ser un claro indicador de un hogar con bajos ingresos, hacia el interior de los hogares con presencia de ambas condiciones puede existir una dispersión de ingresos significativa. Es decir, mientras que la ausencia de estas condiciones básicas serían suficientes para considerar un hogar como de bajos ingresos, su presencia es necesaria más no suficiente para considerar a un hogar como de altos ingresos.

La hipótesis de este trabajo es que, de las variables disponibles tanto en el **Censo** como en la **EAHU**, son aquellas vinculadas a los años de escolaridad, a la condición de actividad y a la conformación del hogar las que mayor relación presentan con el ingreso de modo que nos permitan poder determinar caracterizar a un hogar como de altos ingresos. Sin embargo, es de esperar que, mientras que este conjunto de variables pueda servir para la identificación del extremo superior de la escala de ingresos, no sea tan sensible con respecto al segmento inferior.

Es por ello que se presume que es necesario el análisis conjunto y complementario de ambos sets de varibles, unas para identificar positivamente los sectores de más altos ingresos y el otro para indentificar positivamente los sectores de menores ingresos.

#Variables candidatas como proxy del ingreso

A partir de la **EAHU** se puede determinar el sentido y la fuerza de la relación entre las variables seleccionadas, que también se pueden encontrar en el **Censo**, y el ingreso per cápita familiar, que es el tipo de ingreso seleccionado en este trabajo.  

## Variables individuales presentes en EAHU y Censo


```{r,tablaModelos}
base = select(hogares,ipcf,jefaturaFemenina,jefaturaCompleta,habitanteUnico,hogaresMult,nbi1:nbi,aniosEscolaridad,propietario,jefeNacidoArg)

matrizCorrelaciones = cor(base)

ponderadores = hogares$pondera
tablaModelos = data.frame(variable = NA, beta = NA, pbeta = NA, r = NA, pValue = NA)

# Recorro creo subases de a una variable a la vez para hacer una tabla de modelos y sus parametros 
for (i in 2:ncol(base)) {
fit = lm(ipcf ~ .,data=base[,c(1,i)],weights = ponderadores)
f <- summary(fit)$fstatistic
tablaModelosInsumo = data.frame(
  variable = names(fit$coefficients[2]), 
  beta = fit$coefficients[2], 
  pbeta = coef(summary(fit))[2,4], 
  r = summary(fit)$adj.r.squared, 
  pValue = pf(f[1],f[2],f[3],lower.tail=F))
tablaModelos = rbind(tablaModelos,tablaModelosInsumo)
}
tablaModelos = tablaModelos[2:nrow(tablaModelos),]
```

De esta tabla se puede extraer como conclusión que de todos los modelos lineales simples, los años de escolaridad en el hogar (construido a partir de los años de escolaridad del jefe y/o cónyuge ) es la variable que explica la mayor variabilidad del ingreso y, al mismo tiempo, la mayor significatividad estadística al aportar el menor *p-value*. El sentido de la relación, como es de esperar, es positivo de modo que a mayor cantidad de años de escolaridad del jefe y/o cónyuge del hogar, es de esperar un ingreso mayor en ese hogar. También es necesario considerar la presencia en el hogar de algún indicador de NBI, que hacen referenia a las condiciones habitacionales y de insfraestructura de los hogares, como una variable relacionada en sentido negativo con el ingreso del hogar (aunque en magnitudes menos significativas que *Años de escolaridad*, así como también con mayores, aunque aceptales, niveles de error)

Por último, también es importante considerar la nacionalidad del jefe de hogar, dado que se espera una relación negativa (aunque de intensidad poco significativa) entre la condición de inmigrante del jefe y el ingreso del hogar.

## Indicadores construidos a partir de variables presentes en EAHU y Censo

A priori, se puede comenzar a fundamentar algunas presunciones tomadas al inicio del trabajo. En primer lugar, el grado de desarrollo urbano de la Ciudad de Buenos Aires, hace que aquellos indicadores que la bibliografía asume como negativamente vinculados con el ingreso (como los resumidos en los diferentes componentes del NBI) no tengan suficiente significatividad económica ni estadística. De modo que si bien puedan ser útiles para poder identificar y georeferenciar nichos de pobreza estructural, no sirven para identificar el otro extremo de la distribución del ingreso.

Complementariamente, los años de escolaridad se presentan como la variable más significativa para una identificación positiva de los sectores de latos ingresos. Pero un modelo de regresión lineal simple de ingreso sobre esta variable, explica muy poco de la variabilidad de los ingresos. Es por eso que es necesario la utilización de otra serie de indicadores construidos a partir de las variables simples que permitan un mejor análisis.


```{r}
#1 CONDHAB
source("src/condhab.R") #NO FUNCIONA
hogares = left_join(hogares, condhab)
rm(condhab)

#2 para cada hogar CAPECO = (CP * VAE) / AE
source("src/capeco.R")
hogaresCAPECO = 
  personas %>%
  group_by(idHogar) %>%
  summarise(capeco = sum(cp * vae)/sum(adultoEquivalente))

hogares = left_join(hogares, hogaresCAPECO)

capecoPersonas = select(hogares,idHogar,capeco)

personas = left_join(personas,capecoPersonas)

capecoPersonas = arrange(personas,capeco,desc(ipcf),idHogar)

rm(hogaresCAPECO)

```

La búsqueda de indicadores de ingresos corrientes para referir a los aspectos menos estructurales de la pobreza y, de algún modo compatibilizar las encuestas urbanas de ocupación e ingreso con las variables censales, ha sido una preocupación en años anteriores. 

para eso se desarrollaron indicadores como CONDAHB capeco explicacion

```{r,tablaModelos}
base = select(hogares,ipcf,capeco,condhab)
base$condhab = as.numeric(base$condhab)

matrizCorrelaciones = cor(base)

tablaModelos2 = data.frame(variable = NA, beta = NA, pbeta = NA, r = NA, pValue = NA)

# Recorro creo subases de a una variable a la vez para hacer una tabla de modelos y sus parametros 
for (i in 2:ncol(base)) {
fit = lm(ipcf ~ .,data=base[,c(1,i)],weights = ponderadores)
f <- summary(fit)$fstatistic
tablaModelosInsumo2 = data.frame(
  variable = names(fit$coefficients[2]), 
  beta = fit$coefficients[2], 
  pbeta = coef(summary(fit))[2,4], 
  r = summary(fit)$adj.r.squared, 
  pValue = pf(f[1],f[2],f[3],lower.tail=F))
tablaModelos2 = rbind(tablaModelos2,tablaModelosInsumo2)
}
tablaModelos2 = tablaModelos[2:nrow(tablaModelos2),]
```

Se observa que capeco es un mucho mejor candidato como variable única a la hora de detectar sectores de altos ingresos, mientras que condhab es menos competitiva que algun indicador de nbi

```{r}
with(base,plot(capeco,ipcf))
```

```{r}
fit = lm(ipcf ~ capeco, data = hogares, weights = pondera)
summary(fit)
plot(fit)
```


Ajustes

se observan outliers que se explican claramente por el ingreso. son aquellos que ganan mas de 15000 per capita

```{r, modelo ajustado}
outliers.ipcf = hogares$ipcf>15000
hogaresSinOut = hogares[!outliers.ipcf,]
```

```{r}
fit2 = lm(ipcf ~ capeco, data = hogaresSinOut, weights = pondera)
summary(fit2)
plot(fit2)
```

#Variable en el Censo 2010: análisis y distribución
#Mapa del ingreso en la Ciudad de Buenos Aires
 Probar mapas competitivos
#Análisis del mapa del ingreso 


